<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="../admin-chatbot.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/material-icons@1.13.12/iconfont/material-icons.min.css">
    <script src="nav.js" defer></script>
    
  <style>
    form{
        display: flex;
        flex-direction: column;
        width: 50%;
        margin: 0 auto;
    }
    input, textarea{
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    button{
        padding: 10px;
        border: none;
        border-radius: 5px;
        background-color: #333;
        color: #fff;
        cursor: pointer;
    }
    button:hover{
        background-color: #555;
    }

  </style>
    
    <script src="../admin-chatbot.js" defer></script>
</head>
<body style="width: 100%;">
   
    <div class="customer_container">
        <div id="navbar-container"></div>
        <main> <div class="cust_right">
        <div class="top">
            <button id="menu-btn">
                <span class="material-icons-sharp">menu</span>
            </button>
            <div class="theme-toggler">
                <span class="material-icons-sharp active">light_mode</span>
                <span class="material-icons-sharp">dark_mode</span>
            </div>
            <div class="profile">
                <div class="info">
                    <p>Hey, <b>Asad</b></p>
                    <small class="text-muted">Admin</small>
                </div>
                <div class="profile-photo">
                    <img src="images/profile-1.jpg" alt="">
                </div>
            </div>
        </div>
    </div>
            
    <div>
        <form method="POST" id="add-discount-form">
            <h3 style="text-align: center;">Add a New Discount</h3>
       <!-- Discount Code: 5-digit alphanumeric -->
<input type="text" name="discount_code" pattern="[A-Za-z0-9]{5}" placeholder="Discount Code" required title="Enter a 5-character alphanumeric discount code.">

<!-- Discount Percentage: Numeric with up to 2 decimal places (e.g., 10, 10.5, 10.75) -->
<input type="number" step="0.01" min="0" max="100" name="discount_percentage" placeholder="Discount Percentage" required title="Enter a discount percentage between 0 and 100.">

<!-- Start Date: Uses datetime-local, no pattern needed -->
<input type="datetime-local" name="start_date" placeholder="Start Date" required>

<!-- End Date: Uses datetime-local, no pattern needed -->
<input type="datetime-local" name="end_date" placeholder="End Date" required>

<!-- Max Uses: Only allows whole positive numbers -->
<input type="number" name="max_uses" min="1" step="1" placeholder="Max Uses" required title="Enter a positive whole number for max uses.">

            <button type="submit">Add Discount</button>
        </form>
    </div>

    <div>
        <form method="POST" id="update-discount-form">
            <h3 style="text-align: center;">Update Discount</h3>
            <input type="number" name="discount_id" placeholder="Discount ID" required>
            <input type="text" name="discount_code" pattern="[A-Za-z0-9]{5}" placeholder="Discount Code"  title="Enter a 5-character alphanumeric discount code." required>
            <input type="number" step="0.01" min="0" max="100" name="discount_percentage"  placeholder="Discount Percentage" title="Enter a discount percentage between 0 and 100." required>
            <input type="datetime-local" name="start_date" placeholder="Start Date" required>
            <input type="datetime-local" name="end_date" placeholder="End Date"     required>
            <input type="number" name="max_uses" placeholder="Max Uses" min="1" step="1"  title="Enter a positive whole number for max uses." required>
            <button type="submit">Update Discount</button>
        </form>
    </div>

    <div>
        <form method="POST" id="delete-discount-form">
            <h3 style="text-align: center;">Delete Discount</h3>
            <input type="number" name="discount_id" placeholder="Discount ID" required>
            <button type="submit">Delete Discount</button>
        </form>
    </div>
<div class="recent-order">
    <h2>Discount Details</h2>
    <table width="100%">
        <thead>
            <tr>
                
                <th> Id</th>
                <th>%off</th>
                
                
             
                
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

  </div>

        </main>
      
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
  const token = localStorage.getItem("adminToken");

  if (!token) {
    alert("Access denied. Please log in as an admin.");
    window.location.href = "../admin.html"; // Redirect to login page
  }
});


async function fetchDiscounts() {
    const token = localStorage.getItem("adminToken");

  if (!token) {
    alert("Access denied. Please log in as an admin.");
    window.location.href = "../admin.html"; // Redirect to login page
  }
    try {
        const response = await fetch('/discounts/get-all',{
            method: 'GET',
            headers: {
                 Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'}
        });
        if (!response.ok) {
            throw new Error('Failed to fetch discount data');
        }
        const discounts = await response.json();
        const tbody = document.querySelector('tbody');
        tbody.innerHTML = '';
        
        discounts.forEach(discount => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${discount.discount_id}</td>
                <td>${discount.discount_percentage}%</td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error fetching discounts:', error);
    }
}

document.getElementById('add-discount-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = {
        discount_code: formData.get('discount_code'),
        discount_percentage: formData.get('discount_percentage'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        max_uses: formData.get('max_uses')
    };
    const token = localStorage.getItem("adminToken");

  if (!token) {
    alert("Access denied. Please log in as an admin.");
    window.location.href = "../admin.html"; // Redirect to login page
  }
    try {
        const response = await fetch('/discounts/add-discount', {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (response.ok) {
            alert('Discount added successfully');
            form.reset();
            fetchDiscounts();
        } else {
            throw new Error('Failed to add discount');
        }
    } catch (error) {
        console.error('Error adding discount:', error);
    }
});

document.getElementById('update-discount-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = {
        discount_id: formData.get('discount_id'),
        discount_code: formData.get('discount_code'),
        discount_percentage: formData.get('discount_percentage'),
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date'),
        max_uses: formData.get('max_uses')
    };
    const token = localStorage.getItem("adminToken");

  if (!token) {
    alert("Access denied. Please log in as an admin.");
    window.location.href = "../admin.html"; // Redirect to login page
  }
    try {
        const response = await fetch('/discounts/update-discount', {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (response.ok) {
            alert('Discount updated successfully');
            form.reset();
            fetchDiscounts();
        } else {
            throw new Error('Failed to update discount');
        }
    } catch (error) {
        console.error('Error updating discount:', error);
    }
});

document.getElementById('delete-discount-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = { discount_id: formData.get('discount_id') };
    const token = localStorage.getItem("adminToken");

  if (!token) {
    alert("Access denied. Please log in as an admin.");
    window.location.href = "../admin.html"; // Redirect to login page
  }
    try {
        const response = await fetch('/discounts/delete-discount', {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (response.ok) {
            alert('Discount deleted successfully');
            form.reset();
            fetchDiscounts();
        } else {
            throw new Error('Failed to delete discount');
        }
    } catch (error) {
        console.error('Error deleting discount:', error);
    }
});

window.addEventListener('DOMContentLoaded', fetchDiscounts);


    </script>
</body>
</html>
